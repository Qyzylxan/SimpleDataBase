<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h1>
            <a href="/" class="btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ñ–æ—Ä–º–µ</a>
        </div>
        
        {{if .}}
        <div class="controls">
            <div class="selection-controls">
                <button id="selectAllBtn" class="btn secondary" onclick="toggleSelectAll()">
                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                </button>
                <button id="deleteSelectedBtn" class="btn danger" onclick="prepareDeleteSelected()" disabled>
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                </button>
            </div>
            <div class="stats">
                <span id="selectedCount">–í—ã–±—Ä–∞–Ω–æ: 0</span>
                <span>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {{len .}}</span>
            </div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="50px">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllCheckboxes()">
                        </th>
                        <th>ID</th>
                        <th>–ò–º—è</th>
                        <th>–§–∞–º–∏–ª–∏—è</th>
                        <th>Email</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th width="100px">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .}}
                    <tr id="user-{{.ID}}" data-user-id="{{.ID}}">
                        <td>
                            <input type="checkbox" class="user-checkbox" onchange="updateSelection()">
                        </td>
                        <td>{{.ID}}</td>
                        <td>{{.FirstName}}</td>
                        <td>{{.LastName}}</td>
                        <td>{{.Email}}</td>
                        <td>{{.Phone}}</td>
                        <td>
                            <button class="btn-icon delete-single" onclick="deleteSingleUser('{{.ID}}', '{{.FirstName}} {{.LastName}}')" 
                                    title="–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{else}}
        <div class="empty-state">
            <h2>üìù –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
            <p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
            <a href="/" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</a>
        </div>
        {{end}}

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
                <p id="modalMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?</p>
                <div class="modal-buttons">
                    <button onclick="confirmDelete()" class="btn danger">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                    <button onclick="closeModal()" class="btn secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ -->
        <div id="message" class="message"></div>
    </div>

    <script>
        let selectedUserIds = [];
        let currentDeleteType = ''; // 'single' –∏–ª–∏ 'multiple'
        let currentSingleUserId = null;
        let currentSingleUserName = '';

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
        function toggleAllCheckboxes() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            const checkboxes = document.querySelectorAll('.user-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            
            updateSelection();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            selectAllCheckbox.checked = !selectAllCheckbox.checked;
            toggleAllCheckboxes();
        }

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            selectedUserIds = [];
            
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const userId = parseInt(row.dataset.userId);
                selectedUserIds.push(userId);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏ –∫–Ω–æ–ø–∫—É
            const selectedCount = document.getElementById('selectedCount');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            
            selectedCount.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selectedUserIds.length}`;
            deleteBtn.disabled = selectedUserIds.length === 0;
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≥–ª–∞–≤–Ω—ã–π —á–µ–∫–±–æ–∫—Å
            const totalCheckboxes = document.querySelectorAll('.user-checkbox').length;
            const checkedCount = checkboxes.length;
            document.getElementById('selectAllCheckbox').checked = checkedCount > 0 && checkedCount === totalCheckboxes;
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è
        function deleteSingleUser(id, name) {
            currentDeleteType = 'single';
            currentSingleUserId = id;
            currentSingleUserName = name;
            
            showModal(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${name}" (ID: ${id})?`);
        }

        function prepareDeleteSelected() {
            if (selectedUserIds.length === 0) return;
            
            currentDeleteType = 'multiple';
            showModal(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedUserIds.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?`);
        }

        function showModal(message) {
            const modal = document.getElementById('confirmModal');
            const messageElement = document.getElementById('modalMessage');
            
            messageElement.textContent = message;
            modal.style.display = 'block';
        }

        async function confirmDelete() {
            try {
                let response;
                
                if (currentDeleteType === 'single') {
                    // –£–¥–∞–ª–µ–Ω–∏–µ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    response = await fetch(`/delete/${currentSingleUserId}`, {
                        method: 'DELETE'
                    });
                } else {
                    // –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
                    response = await fetch('/delete/', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ user_ids: selectedUserIds })
                    });
                }

                const result = await response.json();
                
                const messageDiv = document.getElementById('message');
                if (result.success) {
                    messageDiv.textContent = result.message;
                    messageDiv.className = 'message success';
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                    if (currentDeleteType === 'single') {
                        const row = document.getElementById(`user-${currentSingleUserId}`);
                        if (row) {
                            row.style.opacity = '0';
                            setTimeout(() => row.remove(), 300);
                        }
                    } else {
                        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
                        selectedUserIds.forEach(userId => {
                            const row = document.getElementById(`user-${userId}`);
                            if (row) {
                                row.style.opacity = '0';
                                setTimeout(() => row.remove(), 300);
                            }
                        });
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                        selectedUserIds = [];
                        updateSelection();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    updateStats();
                } else {
                    messageDiv.textContent = result.message;
                    messageDiv.className = 'message error';
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = 'message';
                }, 3000);
                
            } catch (error) {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
                messageDiv.className = 'message error';
            }
            
            closeModal();
        }

        function closeModal() {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            currentDeleteType = '';
            currentSingleUserId = null;
            currentSingleUserName = '';
        }

        function updateStats() {
            const rows = document.querySelectorAll('tbody tr');
            const stats = document.querySelector('.stats');
            
            if (stats) {
                const totalSpan = stats.querySelector('span:last-child');
                if (totalSpan && rows.length > 0) {
                    totalSpan.textContent = `–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${rows.length}`;
                } else if (rows.length === 0) {
                    // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    setTimeout(() => location.reload(), 1000);
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        window.onclick = function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            updateSelection();
        });
    </script>
</body>
</html>